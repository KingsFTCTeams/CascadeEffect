/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Module: MagneticBaton.h
//
// Description:
//        Magnetic baton detection interface
//
// Usage:
//        1) Run the DetectMagnet task
//        2) Call SawMagnet() to determine if a magnetic baton is detected
//
// Direct Motor Use:
//        none
//
// Direct Sensor Use:
//        Magnetic sensor (duh!)
//        Plays a sound if a magnetic baton is detected
//
// Timer Use:
//        T4 - times how long since we detected the magnet
//
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#ifndef MAGNETIC_BATON_H
#define MAGNETIC_BATON_H

#pragma systemFile            // this eliminates warning for "unreferenced" functions

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Includes
//
#ifndef INDICATOR_H
#include "Indicator.h"
#endif

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// #defines
//

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Public Global Variables
//
bool bMagnetDetected = false;
bool bMagBatonOverridePressed = false;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Private Global Variables
//

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Public Function Declarations
//
#define DetectedMagnet()	( bMagBatonOverridePressed ? false : bMagnetDetected )
#define SetMagnetOverride(flag) { bMagBatonOverridePressed = flag; }

/////////////////////////////////////////////////////////////////////////////////////////
//
// PRIVATE FUNCTION: initialization
//
#define initMagnetDetection() \
{                             \
  initializeIndicator();      \
	bMagnetDetected = false;    \
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Private Function Declarations
//

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Task Definitions
//
//    Autonomous: stop and indicate if see magnet ... with the doubler it is worth 50 pts.
//
//    Teleop: stop and indicate ... timeout to release ... joy2 button to override
//
task DetectMagnetTask()
{
	int nNumCycles = 0;
	bool bBrokeThreshold = false;

	initMagnetDetection();

	while (true)
	{
#ifdef ENABLE_MAGNETIC_BATON_DETECTION
    if ( !AutonomousIsAborted() )
    {
	    //
	    // Only check for the magnetic baton if this feature is enabled
	    //
      if ( !bMagnetDetected )
      {
	      bBrokeThreshold = (absValue(MagneticSensorVal()) > MAGNET_DETECT_THRESHOLD);

	      if ( bBrokeThreshold && nNumCycles >= NUM_CYCLE_MUST_SEE_MAGNET ) // Seen magnet long enough
				{
					bMagnetDetected = true;
					ClearTimer(T4);
				}
				else if ( bBrokeThreshold )	// Detected Magnet...make sure not just a spike
				{
				  nNumCycles++;
				}
				else
				{
				  nNumCycles = 0;
				}
      }

			else if ( time1[T4] > DETECT_MAG_EXPIRATION_TIMER )	// Reset After Expiration
			{
				bMagnetDetected = false;
			}
		}
#endif

		wait1Msec(DETECT_MAG_POLL_INTERVAL);

	}
}

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Function Definitions
//

/////////////////////////////////////////////////////////////////////////////////////////
//
// PRIVATE FUNCTION: <description>
//

/////////////////////////////////////////////////////////////////////////////////////////
//
// PRIVATE FUNCTION: <description>
//

#endif // MAGNETIC_BATON_H
